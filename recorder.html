<!doctype html><meta charset="utf-8"><title>Proto Table Recorder - single row per turn</title>
<table id=tbl border=1 cellpadding=6 style="border-collapse:collapse;font-family:sans-serif;font-size:14px">
  <thead>
    <tr>
      <th>Record</th><th>Audio</th><th>STT</th><th>Transcript</th><th>Ask LLM</th><th>LLM Reply</th><th>TTS</th><th>TTS Audio</th><th>+ Row</th>
    </tr>
  </thead>
  <tbody id=body></tbody>
</table>
<script>
const body=document.getElementById('body');
function pick(){for(const m of ['audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/mp4','audio/webm']) if(window.MediaRecorder&&MediaRecorder.isTypeSupported(m)) return m; return ''}
function btn(txt,fn){ const b=document.createElement('button'); b.textContent=txt; b.onclick=fn; return b }
function addTurnRow(){
  const tr=document.createElement('tr');
  const cRec=tr.insertCell();
  const cAudio=tr.insertCell();
  const cSTT=tr.insertCell();
  const cTxt=tr.insertCell();
  const cAsk=tr.insertCell();
  const cLLM=tr.insertCell();
  const cTTS=tr.insertCell();
  const cTTSA=tr.insertCell();
  const cPlus=tr.insertCell();

  // per row state
  let rec=null, stream=null, chunks=[], lastBlob=null;

  const recordBtn=btn('Record', async()=>{
    if(!rec||rec.state==='inactive'){
      try{
        recordBtn.disabled=true;
        stream=await navigator.mediaDevices.getUserMedia({audio:true});
        const mt=pick(); chunks=[]; rec=new MediaRecorder(stream, mt?{mimeType:mt}:{})
        rec.ondataavailable=e=>e.data&&e.data.size&&chunks.push(e.data);
        rec.onstop=()=>{
          const type=rec.mimeType||'audio/webm';
          lastBlob=new Blob(chunks,{type});
          const url=URL.createObjectURL(lastBlob);
          const a=document.createElement('audio'); a.controls=true; a.src=url; cAudio.innerHTML=''; cAudio.append(a);
          // stop tracks
          if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null }
        };
        rec.start();
        recordBtn.textContent='Stop';
      }catch(e){ alert('Mic permission needed - use HTTPS or http://localhost'); }
      finally{ recordBtn.disabled=false }
    } else {
      rec.stop();
      recordBtn.textContent='Record';
    }
  });
  cRec.append(recordBtn);

  // STT - dummy
  cSTT.append(btn('Transcribe', ()=>{
    cTxt.textContent='dummy transcription';
  }));

  // Ask LLM - dummy
  cAsk.append(btn('Ask LLM', ()=>{
    const t=cTxt.textContent||'';
    cLLM.textContent = 'dummy response: '+t;
  }));

  // TTS - dummy using recorded audio
  cTTS.append(btn('TTS', ()=>{
    if(!lastBlob){ alert('Record first to have dummy TTS audio'); return }
    const a=document.createElement('audio'); a.controls=true; a.src=URL.createObjectURL(lastBlob);
    cTTSA.innerHTML=''; cTTSA.append(a);
  }));

  // + add new row
  cPlus.append(btn('+', addTurnRow));

  body.append(tr);
}

if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
  const tr=document.createElement('tr'); tr.insertCell().textContent='Not supported'; body.append(tr);
} else {
  addTurnRow();
}
</script>
